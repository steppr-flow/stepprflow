# =============================================================================
# Docker Compose for Steppr Flow Dashboard (Production)
#
# This compose file provides a standalone monitoring dashboard with:
# - MongoDB for workflow execution persistence
# - Steppr Flow Dashboard (backend + embedded UI)
#
# The dashboard connects to your existing Kafka/RabbitMQ infrastructure.
# =============================================================================
#
# Usage:
#   # Configure your broker connection
#   export KAFKA_BOOTSTRAP_SERVERS=your-kafka:9092
#   # Or for RabbitMQ
#   export RABBITMQ_HOST=your-rabbitmq
#
#   docker-compose -f docker-compose.prod.yml up -d
#
# =============================================================================

services:
  # ===========================================================================
  # MongoDB - Workflow execution persistence
  # ===========================================================================
  mongodb:
    image: mongo:7.0
    container_name: stepprflow-mongodb
    restart: unless-stopped
    ports:
      - "${MONGODB_PORT:-27017}:27017"
    environment:
      MONGO_INITDB_DATABASE: stepprflow
      MONGO_INITDB_ROOT_USERNAME: ${MONGODB_USERNAME:-stepprflow}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_PASSWORD:-stepprflow}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
    healthcheck:
      test: ["CMD", "mongosh", "-u", "${MONGODB_USERNAME:-stepprflow}", "-p", "${MONGODB_PASSWORD:-stepprflow}", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 20s
    networks:
      - stepprflow-network

  # ===========================================================================
  # Steppr Flow Dashboard (Backend + Embedded UI)
  # ===========================================================================
  dashboard:
    image: ghcr.io/stepprflow/stepprflow-dashboard:${STEPPR_FLOW_VERSION:-latest}
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stepprflow-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-8090}:8090"
    environment:
      # Server configuration
      SERVER_PORT: 8090
      SPRING_PROFILES_ACTIVE: docker

      # MongoDB configuration
      SPRING_DATA_MONGODB_URI: mongodb://${MONGODB_USERNAME:-stepprflow}:${MONGODB_PASSWORD:-stepprflow}@mongodb:27017/stepprflow?authSource=admin

      # Kafka configuration (connect to your existing Kafka)
      SPRING_KAFKA_BOOTSTRAP_SERVERS: ${KAFKA_BOOTSTRAP_SERVERS:-localhost:9092}
      SPRING_KAFKA_CONSUMER_GROUP_ID: stepprflow-dashboard

      # RabbitMQ configuration (if using RabbitMQ instead of Kafka)
      SPRING_RABBITMQ_HOST: ${RABBITMQ_HOST:-localhost}
      SPRING_RABBITMQ_PORT: ${RABBITMQ_PORT:-5672}
      SPRING_RABBITMQ_USERNAME: ${RABBITMQ_USERNAME:-guest}
      SPRING_RABBITMQ_PASSWORD: ${RABBITMQ_PASSWORD:-guest}

      # Steppr Flow configuration
      STEPPR_FLOW_MONITORING_ENABLED: "true"
      STEPPR_FLOW_WEBSOCKET_ENABLED: "true"

      # JVM configuration
      JAVA_OPTS: >-
        -XX:+UseContainerSupport
        -XX:MaxRAMPercentage=75.0
        -XX:+UseG1GC
        -Djava.security.egd=file:/dev/./urandom

      # Logging
      LOGGING_LEVEL_IO_STEPPRFLOW: ${LOG_LEVEL:-INFO}
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - stepprflow-network

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  stepprflow-network:
    driver: bridge
    name: stepprflow-network
